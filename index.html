<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chatbot</title>
    <style>
        :root{
            --bg: #f6f8fb;
            --panel: #ffffff;
            --accent: #1f6feb;
            --user-bg: #e7f0ff;
            --bot-bg: #f1f7ef;
            --muted: #6b7280;
        }
        html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;color:#0f172a}
        /* Subtle layered background: soft gradient + faint dot pattern for depth */
        body {
            background: linear-gradient(135deg, #f0f6ff 0%, #f9fbff 100%);
            background-attachment: fixed;
        }
        /* faint repeating dots using radial-gradient */
        body::before{
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: radial-gradient(rgba(15,23,42,0.03) 1px, transparent 1px);
            background-size: 18px 18px;
            opacity: 0.9;
        }
        .app{
            min-height:100%;display:flex;align-items:stretch;justify-content:center;padding:24px;box-sizing:border-box
        }
        .chat-panel{
            width:100%;max-width:900px;background:var(--panel);border-radius:12px;box-shadow:0 6px 24px rgba(15,23,42,0.08);display:flex;flex-direction:column;overflow:hidden;
        }
        .chat-header{padding:18px 20px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;gap:12px}
        .chat-title{font-weight:600;font-size:1.05rem}
        #conversation{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
        .message{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.4;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
        .message.user{align-self:flex-end;background:var(--user-bg);border-bottom-right-radius:6px}
        .message.bot{align-self:flex-start;background:var(--bot-bg);border-bottom-left-radius:6px}
        .meta{font-size:0.82rem;color:var(--muted);margin-bottom:6px}
        .input-area{padding:12px;border-top:1px solid #eef2f7;display:flex;gap:8px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.01))}
        .input-area input{flex:1;padding:12px 14px;border-radius:8px;border:1px solid #e6edf3;font-size:1rem;outline:none}
        .input-area button{padding:10px 16px;background:var(--accent);border:none;color:white;border-radius:8px;cursor:pointer;transition:background 160ms ease, transform 80ms ease}
        /* Hover and focus states for better affordance */
        .input-area button:hover,
        .input-area button:focus{
            background:#1558c7; /* slightly darker accent */
            outline: none;
            transform: translateY(-1px);
        }
        .input-area button:active{transform:translateY(1px)}
        .loader{display:inline-block;width:16px;height:16px;border:3px solid #d1d5db;border-top:3px solid #111;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

        /* Responsive tweaks */
        @media (max-width:600px){
            .chat-panel{border-radius:8px}
            .message{max-width:92%}
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="chat-panel" role="main" aria-label="Chat interface">
            <div class="chat-header">
                <div class="chat-title">Chatbot</div>
                <div style="margin-left:auto;font-size:.9rem;color:var(--muted)">Responsive UI</div>
            </div>
            <div id="conversation" aria-live="polite"></div>
            <div class="input-area">
                <input id="inputBox" type="text" placeholder="Type your message..." aria-label="Message input" onkeydown="if(event.key==='Enter'){sendToPython();}">
                <button onclick="sendToPython()" aria-label="Send">Send</button>
            </div>
        </div>
    </div>

    <script>
        const conversation = document.getElementById('conversation');
        let history = [];

        function formatMessage(sender, text){
            const wrapper = document.createElement('div');
            wrapper.className = 'message ' + (sender === 'You' ? 'user' : 'bot');
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = sender;
            const body = document.createElement('div');
            body.className = 'body';
            body.innerText = text;
            wrapper.appendChild(meta);
            wrapper.appendChild(body);
            return wrapper;
        }

        function appendMessage(sender, text, id){
            // if id provided, create placeholder then later update
            if(id){
                const placeholder = formatMessage(sender, '');
                placeholder.querySelector('.body').id = id;
                conversation.appendChild(placeholder);
                conversation.scrollTop = conversation.scrollHeight;
                return;
            }
            const el = formatMessage(sender, text);
            conversation.appendChild(el);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function sendToPython(){
            const inputBox = document.getElementById('inputBox');
            const value = inputBox.value.trim();
            if(!value) return;
            appendMessage('You', value);
            history.push({ role: 'user', content: value });
            inputBox.value = '';

            // placeholder for bot
            const botMsgId = 'botmsg-' + Date.now();
            appendMessage('Bot', '', botMsgId);
            const botBody = document.getElementById(botMsgId);
            if(botBody) botBody.innerHTML = '<span class="loader" aria-hidden="true"></span>';

            fetch('/api/submit',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ history })
            }).then(async r => {
                // Read raw text first so we can handle non-JSON responses or empty bodies
                const text = await r.text();
                if (!r.ok) {
                    // If server returned an error, surface the body or status
                    throw new Error(text || ('Request failed: ' + r.status));
                }
                try {
                    return text ? JSON.parse(text) : { error: 'Empty response from server' };
                } catch (parseErr) {
                    throw new Error('Invalid JSON response: ' + text);
                }
            })
            .then(data => {
                const botBody = document.getElementById(botMsgId);
                if (botBody) {
                    if (data && data.response) {
                        botBody.innerText = data.response;
                        history.push({ role: 'bot', content: data.response });
                    } else if (data && data.error) {
                        botBody.innerText = 'Error: ' + (data.detail || data.error);
                    } else {
                        botBody.innerText = 'Error: Unexpected response format';
                    }
                }
            }).catch(err => {
                const botBody = document.getElementById(botMsgId);
                if (botBody) botBody.innerText = 'Error: ' + (err && err.message ? err.message : err);
            });
        }
    </script>
</body>
</html>